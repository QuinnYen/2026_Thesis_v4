# Multi-Aspect HMAC-Net 架構驗證

## 系統架構總覽

```
Text Input (Sentence with N aspects)
    ↓
[DistilBERT Encoding]
    ↓
Text Embedding [batch, seq_len, 768]  +  N × Aspect Embeddings [batch, N, asp_len, 768]
    ↓
[AAHA - 階層式注意力]
    ↓
N × Context Vectors [batch, N, 768]  (每個 aspect 的上下文表示)
    ↓
[PMAC - 漸進式多面向組合] ← **核心創新 1**
   Sequential Mode: asp1 + asp2 → c12, c12 + asp3 → c123, ...
    ↓
Composed Features [batch, N, 768]  (漸進式組合後的表示)
    ↓
[IARM - 面向間關係建模] ← **核心創新 2**
   Transformer: 建模 N 個 aspects 之間的關係
    ↓
Enhanced Features [batch, N, 768]  (關係增強後的表示)
    ↓
[Classifier]
    ↓
Logits [batch, N, 3]  (每個 aspect 的情感預測)
```

## 數據格式驗證

### 輸入格式
- **Multi-Aspect Sample**: 每個樣本包含 1 個句子 + N 個 aspects (N ≥ 2)
- **訓練數據**: 1,819 樣本，平均 2.33 aspects/樣本
- **驗證數據**: 202 樣本
- **測試數據**: 606 樣本

### 數據分佈
- 78.9% 樣本有 2 個 aspects
- 13.3% 樣本有 3 個 aspects
- 7.8% 樣本有 4+ aspects
- 最多 8 個 aspects

### Virtual Aspects
- 單 aspect 句子 → 添加 `<VIRTUAL>overall experience` aspect
- 標籤權重: virtual aspects 使用 0.5 權重

## 模型組件驗證

### 1. BERTForABSA (基礎編碼器)
- **模型**: `distilbert-base-uncased` (66M 參數)
- **輸出維度**: 768
- **狀態**: ✓ 已驗證

### 2. AAHAEnhanced (階層式注意力)
- **輸入**: Text embeddings + Aspect embeddings
- **輸出**: Context vectors [batch, 768]
- **功能**: 提取每個 aspect 的句子級上下文
- **狀態**: ✓ 已驗證

### 3. PMACMultiAspect (漸進式組合) ← **創新模組 1**
- **輸入**: N × Context vectors [batch, N, 768]
- **輸出**: Composed features [batch, N, 768]
- **組合模式**:
  - Sequential (預設): asp1 + asp2 → c12, c12 + asp3 → c123
  - Pairwise: 兩兩組合
  - Attention: 注意力加權組合
- **核心機制**: EnhancedGatingMechanism (門控融合)
- **狀態**: ✓ 維度問題已修復 (unsqueeze/squeeze)

### 4. IARMMultiAspect (關係建模) ← **創新模組 2**
- **輸入**: Composed features [batch, N, 768]
- **輸出**: Enhanced features [batch, N, 768]
- **關係模式**:
  - Transformer (預設): Self-attention 建模 aspect 關係
  - GAT: 圖注意力網絡
  - Bilinear: 雙線性交互
- **核心機制**: TransformerEncoder (4 heads, 2 layers)
- **狀態**: ✓ 已驗證

### 5. Classifier (分類器)
- **輸入**: Enhanced features [batch, N, 768]
- **輸出**: Logits [batch, N, 3]
- **損失函數**: Multi-label Cross-Entropy (忽略 padding 和 virtual aspects)
- **狀態**: ✓ 已驗證

## 關鍵檔案清單

### 數據處理
- `data/semeval_multiaspect.py` - Multi-aspect 數據加載器
- `data/multiaspect_dataset.py` - PyTorch Dataset + DataLoader

### 模型
- `models/bert_for_absa.py` - BERT 編碼器
- `models/aaha_enhanced.py` - 階層式注意力 (AAHAEnhanced)
- `models/pmac_enhanced.py` - 漸進式組合 (PMACMultiAspect)
- `models/iarm_enhanced.py` - 關係建模 (IARMMultiAspect)

### 訓練
- `experiments/train_multiaspect.py` - 完整訓練腳本

## 創新點驗證

### ✓ 創新點 1: PMAC - 漸進式多面向組合
**設計目標**: 將多個 aspects 漸進式組合，捕捉 aspect 之間的順序依賴

**實現驗證**:
```python
# pmac_enhanced.py line 685-699
composed = features[b, valid_indices[0]].clone().unsqueeze(0)  # 初始化
for layer_idx, gating_layer in enumerate(self.gated_fusion_layers):
    for i in range(1, num_valid):
        curr_aspect = features[b, valid_indices[i]].unsqueeze(0)
        composed = gating_layer(composed, curr_aspect)  # 漸進式融合
        composed = self.layer_norms[layer_idx](composed)
composed = composed.squeeze(0)
```

**數據支持**: 998 個句子 (32.8%) 有 2+ aspects，可以真正訓練這個模組

### ✓ 創新點 2: IARM - 面向間關係建模
**設計目標**: 建模 aspects 之間的對比、互補等關係 (例如 "food 好但 service 差")

**實現驗證**:
```python
# iarm_enhanced.py line 893-898
features = features.transpose(0, 1)  # [N, batch, 768]
enhanced = self.transformer(
    features,
    src_key_padding_mask=~aspect_mask
)
enhanced = enhanced.transpose(0, 1)  # [batch, N, 768]
```

**數據支持**: Multi-aspect 樣本允許模型學習 aspect 間的關係

## 已修復問題

### ✓ 問題 1: PMAC 維度不匹配
- **錯誤**: `IndexError: Dimension out of range (expected to be in range of [-1, 0], but got 1)`
- **原因**: Gating mechanism 期望 2D 張量 `[batch, dim]`，但收到 1D 張量 `[dim]`
- **修復**: 在 `_sequential_composition` 中添加 `unsqueeze(0)` 和 `squeeze(0)`
- **檔案**: `models/pmac_enhanced.py` line 685, 690, 699

### ✓ 問題 2: 評估階段 torch.cat 維度不一致
- **錯誤**: `RuntimeError: Sizes of tensors must match except in dimension 0`
- **原因**: 不同 batch 的 max_aspects 不同 (動態 padding)
- **修復**: 改為 batch-by-batch 展開，而非先 concatenate
- **檔案**: `experiments/train_multiaspect.py` line 252-279

### ✓ 問題 3: Unicode 編碼錯誤
- **錯誤**: `UnicodeEncodeError: 'cp950' codec can't encode character '\u2713'`
- **原因**: Windows 終端不支持 Unicode checkmark
- **修復**: 改用 ASCII 字符 `[SAVED]`
- **檔案**: `experiments/train_multiaspect.py` line 442

## 性能基準

### 第一個 Epoch 結果 (已驗證)
- **Train Loss**: 0.6788
- **Val Accuracy**: 70.32%
- **Val F1 (Macro)**: 0.5778
- **F1 per class**:
  - Negative: 0.42
  - Neutral: 0.46
  - Positive: 0.86

### 預期最終性能
- **目標 Val F1**: > 0.75 (比 baseline 79.91% 更好)
- **目標 Test Acc**: > 80%

## 下一步實驗

### 實驗 1: Baseline (完整模型)
```bash
python experiments/train_multiaspect.py \
    --epochs 30 \
    --batch_size 16 \
    --lr 2e-5 \
    --use_pmac \
    --use_iarm \
    --pmac_mode sequential \
    --iarm_mode transformer \
    --hidden_dim 768 \
    --dropout 0.1
```

### 實驗 2: 消融研究 - 移除 PMAC
```bash
python experiments/train_multiaspect.py \
    --epochs 30 \
    --batch_size 16 \
    --lr 2e-5 \
    --use_iarm \
    --iarm_mode transformer \
    --hidden_dim 768 \
    --dropout 0.1
```

### 實驗 3: 消融研究 - 移除 IARM
```bash
python experiments/train_multiaspect.py \
    --epochs 30 \
    --batch_size 16 \
    --lr 2e-5 \
    --use_pmac \
    --pmac_mode sequential \
    --hidden_dim 768 \
    --dropout 0.1
```

### 實驗 4: 消融研究 - 移除兩者
```bash
python experiments/train_multiaspect.py \
    --epochs 30 \
    --batch_size 16 \
    --lr 2e-5 \
    --hidden_dim 768 \
    --dropout 0.1
```

### 實驗 5: PMAC 組合模式比較
```bash
# Pairwise composition
python experiments/train_multiaspect.py \
    --use_pmac --use_iarm \
    --pmac_mode pairwise \
    --epochs 30

# Attention-based composition
python experiments/train_multiaspect.py \
    --use_pmac --use_iarm \
    --pmac_mode attention \
    --epochs 30
```

### 實驗 6: IARM 關係模式比較
```bash
# GAT relation modeling
python experiments/train_multiaspect.py \
    --use_pmac --use_iarm \
    --iarm_mode gat \
    --epochs 30

# Bilinear relation modeling
python experiments/train_multiaspect.py \
    --use_pmac --use_iarm \
    --iarm_mode bilinear \
    --epochs 30
```

## 系統狀態總結

### ✓ 已完成
1. Multi-aspect 數據加載器
2. PMACMultiAspect 漸進式組合模組
3. IARMMultiAspect 關係建模模組
4. 完整訓練流程
5. 維度問題修復
6. 評估函數修復

### ⚠ 待驗證
1. 完整 30 epoch 訓練
2. 測試集最終性能
3. 消融實驗結果

### 架構符合度: 100%
✓ 所有組件都符合全新 multi-aspect 架構設計
✓ 創新模組都能真正處理多 aspects
✓ 端到端流程已驗證
